# Tantivy API å…¼å®¹æ€§ä¿®å¤

**ç”Ÿæˆæ—¶é—´**: 2025-11-14 02:01:27  
**é—®é¢˜**: `module 'tantivy' has no attribute 'QueryParser'`  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
ERROR:search_engine:Error searching for 'LLM': 
module 'tantivy' has no attribute 'QueryParser'
```

### åŸå› åˆ†æ

**Tantivy Python ç»‘å®šçš„ API åœ¨ä¸åŒç‰ˆæœ¬ä¹‹é—´æœ‰å˜åŒ–**ï¼š

- **æ—§ç‰ˆæœ¬ï¼ˆ< 0.20ï¼‰**: ä½¿ç”¨ `tantivy.QueryParser.for_index()`
- **æ–°ç‰ˆæœ¬ï¼ˆ>= 0.20ï¼‰**: API å‘ç”Ÿå˜åŒ–ï¼Œ`QueryParser` å¯èƒ½ä¸å­˜åœ¨æˆ–ä½ç½®ä¸åŒ
- **ä¸åŒå®‰è£…æ–¹å¼**: PyPI ç‰ˆæœ¬å’Œ conda ç‰ˆæœ¬çš„ API å¯èƒ½ä¸åŒ

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ç®€åŒ–ç‰ˆæœç´¢å¼•æ“ï¼ˆæ¨èï¼‰

åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨æœ€ç®€å•çš„ tantivy APIï¼Œå…¼å®¹æ€§æœ€å¥½ã€‚

**æ–°æ–‡ä»¶**: `/workspace/frontend/search_engine_simple.py`

**æ ¸å¿ƒæ”¹è¿›**:
1. ä½¿ç”¨ `index.parse_query()` è€Œä¸æ˜¯ `QueryParser.for_index()`
2. åˆ›å»ºç»Ÿä¸€çš„ `search_text` å­—æ®µï¼Œç®€åŒ–æŸ¥è¯¢
3. é¿å…ä½¿ç”¨å¤æ‚çš„ API

**ä»£ç ç¤ºä¾‹**:
```python
# ç®€åŒ–ç‰ˆ - ä½¿ç”¨æœ€ç®€å•çš„ API
class SimplePaperSearchEngine:
    def search(self, query: str, ...):
        # ä½¿ç”¨ç´¢å¼•å¯¹è±¡çš„ parse_query æ–¹æ³•
        query_obj = self.index.parse_query(query, ["search_text"])
        search_results = searcher.search(query_obj, limit=max_results)
```

### æ–¹æ¡ˆ 2ï¼šå¤šç‰ˆæœ¬å…¼å®¹ï¼ˆå¤‡ç”¨ï¼‰

åœ¨åŸç‰ˆæœ¬ä¸­æ·»åŠ äº†å¤šç§ API å°è¯•ï¼Œè‡ªåŠ¨é€‚é…ä¸åŒç‰ˆæœ¬ã€‚

**ä¿®æ”¹æ–‡ä»¶**: `/workspace/frontend/search_engine.py`

**ä»£ç ç¤ºä¾‹**:
```python
# å…¼å®¹ä¸åŒç‰ˆæœ¬
try:
    # å°è¯•æ–°ç‰ˆæœ¬ API
    if hasattr(tantivy, 'QueryParser'):
        query_parser = tantivy.QueryParser.for_index(...)
        parsed_query = query_parser.parse_query(query)
    else:
        # ä½¿ç”¨ç´¢å¼•å¯¹è±¡çš„æ–¹æ³•
        parsed_query = self.index.parse_query(query, [...])
except AttributeError:
    # å¤‡ç”¨æ–¹æ¡ˆ
    parsed_query = self.index.parse_query(query)
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. æ›´æ–° Streamlit åº”ç”¨

Streamlit åº”ç”¨å·²è‡ªåŠ¨æ›´æ–°ä¸ºä¼˜å…ˆä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬ï¼š

```python
# streamlit_app.py ä¼šè‡ªåŠ¨é€‰æ‹©
try:
    # ä¼˜å…ˆï¼šç®€åŒ–ç‰ˆï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰
    from search_engine_simple import SimplePaperSearchEngine
except ImportError:
    # å¤‡ç”¨ï¼šå®Œæ•´ç‰ˆ
    from search_engine import PaperSearchEngine
```

### 2. æµ‹è¯•æœç´¢å¼•æ“

```bash
cd /workspace/frontend

# æµ‹è¯•ç®€åŒ–ç‰ˆæœ¬
python test_simple_search.py
```

### 3. é‡å¯ Streamlit

```bash
# åœæ­¢å½“å‰è¿è¡Œçš„ Streamlitï¼ˆCtrl+Cï¼‰

# é‡æ–°å¯åŠ¨
streamlit run streamlit_app.py
```

ç°åœ¨æœç´¢åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼

---

## ğŸ“Š ä¸¤ä¸ªç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | å®Œæ•´ç‰ˆ (search_engine.py) | ç®€åŒ–ç‰ˆ (search_engine_simple.py) |
|------|-------------------------|--------------------------------|
| **å…¼å®¹æ€§** | â­â­ ä¸­ | â­â­â­â­â­ æå¥½ |
| **åŠŸèƒ½** | å®Œæ•´ | æ ¸å¿ƒåŠŸèƒ½ |
| **API ä½¿ç”¨** | å¤æ‚ | ç®€å• |
| **æœç´¢è´¨é‡** | â­â­â­â­â­ | â­â­â­â­â­ |
| **æ¨èåº¦** | âœ… | âœ…âœ…âœ… |

**ä¸¤ä¸ªç‰ˆæœ¬çš„æœç´¢è´¨é‡ç›¸åŒ**ï¼Œéƒ½ä½¿ç”¨ BM25 ç®—æ³•ï¼

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### é—®é¢˜æ ¹æº

Tantivy Python ç»‘å®šï¼ˆtantivy-pyï¼‰çš„ API è®¾è®¡ï¼š

```python
# âŒ æ—§ APIï¼ˆéƒ¨åˆ†ç‰ˆæœ¬ä¸æ”¯æŒï¼‰
query_parser = tantivy.QueryParser.for_index(index, fields)
query = query_parser.parse_query(query_string)

# âœ… é€šç”¨ APIï¼ˆæ‰€æœ‰ç‰ˆæœ¬æ”¯æŒï¼‰
query = index.parse_query(query_string, fields)
```

### ç®€åŒ–ç‰ˆçš„æ”¹è¿›

**1. ç»Ÿä¸€æœç´¢å­—æ®µ**

```python
# åˆ›å»ºç»„åˆå­—æ®µ
search_text = f"{title} {abstract} {authors}"
schema_builder.add_text_field("search_text", stored=False)

# æœç´¢æ—¶åªéœ€è¦æŸ¥è¯¢ä¸€ä¸ªå­—æ®µ
query = self.index.parse_query(query, ["search_text"])
```

**2. ä½¿ç”¨ç´¢å¼•å¯¹è±¡çš„æ–¹æ³•**

```python
# ç›´æ¥ä½¿ç”¨ index å¯¹è±¡çš„ parse_query æ–¹æ³•
# è¿™ä¸ªæ–¹æ³•åœ¨æ‰€æœ‰ç‰ˆæœ¬éƒ½å¯ç”¨
query = self.index.parse_query(query_string, field_names)
```

---

## ğŸ§ª éªŒè¯ä¿®å¤

### æµ‹è¯•æ­¥éª¤

1. **è¿è¡ŒåŸºæœ¬æµ‹è¯•**:
```bash
cd /workspace/frontend
python test_simple_search.py
```

é¢„æœŸè¾“å‡ºï¼š
```
============================================================
æµ‹è¯•ç®€åŒ–ç‰ˆ BM25 æœç´¢å¼•æ“
============================================================

1. å¯¼å…¥æœç´¢å¼•æ“æ¨¡å—...
   âœ… å¯¼å…¥æˆåŠŸ

2. åˆ›å»ºæµ‹è¯•æ•°æ®...
   åˆ›å»ºäº† 4 ç¯‡æµ‹è¯•è®ºæ–‡

3. åˆå§‹åŒ–æœç´¢å¼•æ“...
   âœ… åˆå§‹åŒ–æˆåŠŸ

4. æ„å»ºç´¢å¼•...
   âœ… ç´¢å¼•æ„å»ºæˆåŠŸ

5. æµ‹è¯•æœç´¢...
   æŸ¥è¯¢: 'transformer'
   âœ… æ‰¾åˆ° 3 ä¸ªç»“æœ

...

âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

2. **åœ¨ Streamlit ä¸­æµ‹è¯•**:
```bash
streamlit run streamlit_app.py
```

ç„¶åï¼š
- é€‰æ‹©æ—¥æœŸå’Œåˆ†ç±»
- è¾“å…¥æœç´¢å…³é”®è¯ï¼ˆå¦‚ "transformer"ï¼‰
- åº”è¯¥èƒ½çœ‹åˆ°æœç´¢ç»“æœï¼Œä¸å†æœ‰é”™è¯¯

---

## ğŸ“ æ›´æ–°çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶

1. `/workspace/frontend/search_engine_simple.py` - ç®€åŒ–ç‰ˆæœç´¢å¼•æ“ï¼ˆæ¨èï¼‰
2. `/workspace/frontend/test_simple_search.py` - ç®€åŒ–ç‰ˆæµ‹è¯•è„šæœ¬

### ä¿®æ”¹æ–‡ä»¶

1. `/workspace/frontend/search_engine.py` - æ·»åŠ äº†å¤šç‰ˆæœ¬å…¼å®¹ä»£ç 
2. `/workspace/frontend/streamlit_app.py` - ä¼˜å…ˆä½¿ç”¨ç®€åŒ–ç‰ˆ

---

## ğŸ”„ å¦‚æœä»ç„¶æœ‰é—®é¢˜

### æ£€æŸ¥ tantivy ç‰ˆæœ¬

```bash
pip show tantivy
```

### å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬

```bash
pip install --upgrade tantivy
```

### é‡æ–°å®‰è£…

```bash
pip uninstall tantivy
pip install tantivy
```

### ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬

```bash
# ä½¿ç”¨ 0.21 ç‰ˆæœ¬ï¼ˆbackend ä½¿ç”¨çš„ç‰ˆæœ¬ï¼‰
pip install tantivy==0.21.0
```

### æŸ¥çœ‹å¯ç”¨çš„ API

```python
import tantivy
print(dir(tantivy))

# æ£€æŸ¥æ˜¯å¦æœ‰ QueryParser
print(hasattr(tantivy, 'QueryParser'))

# æ£€æŸ¥ Index å¯¹è±¡çš„æ–¹æ³•
schema = tantivy.SchemaBuilder().build()
index = tantivy.Index(schema)
print(dir(index))
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### æ¨èä½¿ç”¨ç®€åŒ–ç‰ˆ

```python
# åœ¨ä½ çš„ä»£ç ä¸­
from search_engine_simple import SimplePaperSearchEngine, simple_search_papers

# åˆ›å»ºå¼•æ“
engine = SimplePaperSearchEngine()

# æ„å»ºç´¢å¼•
engine.build_index(papers)

# æœç´¢
results = engine.search("transformer")

# æˆ–ä½¿ç”¨ä¾¿æ·å‡½æ•°
results = simple_search_papers("transformer", papers)
```

### Streamlit è‡ªåŠ¨é€‰æ‹©

Streamlit åº”ç”¨ä¼šè‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„ç‰ˆæœ¬ï¼š

1. é¦–å…ˆå°è¯•ç®€åŒ–ç‰ˆï¼ˆæœ€å…¼å®¹ï¼‰
2. å¦‚æœå¤±è´¥ï¼Œå°è¯•å®Œæ•´ç‰ˆ
3. å¦‚æœéƒ½å¤±è´¥ï¼Œå›é€€åˆ°ç®€å•å­—ç¬¦ä¸²åŒ¹é…

**ç”¨æˆ·æ— éœ€æ‰‹åŠ¨é€‰æ‹©ï¼**

---

## ğŸ“š ç›¸å…³èµ„æº

### æ–‡æ¡£

- [Tantivy-py å®˜æ–¹æ–‡æ¡£](https://github.com/quickwit-oss/tantivy-py)
- [Tantivy Rust æ–‡æ¡£](https://docs.rs/tantivy/)

### æœ¬é¡¹ç›®æ–‡æ¡£

- [å®ç°æ€»ç»“](./2025-11-14_02-01-27_implementation_summary.md)
- [ä½¿ç”¨æŒ‡å—](./2025-11-14_02-01-27_bm25_direct_import_guide.md)

---

## âœ… æ€»ç»“

### é—®é¢˜
- `tantivy.QueryParser` åœ¨æŸäº›ç‰ˆæœ¬ä¸å¯ç”¨

### è§£å†³æ–¹æ¡ˆ
- âœ… åˆ›å»ºç®€åŒ–ç‰ˆæœç´¢å¼•æ“ï¼ˆä½¿ç”¨æœ€ç®€å•çš„ APIï¼‰
- âœ… åŸç‰ˆæœ¬æ·»åŠ å¤šç‰ˆæœ¬å…¼å®¹ä»£ç 
- âœ… Streamlit è‡ªåŠ¨é€‰æ‹©æœ€ä½³ç‰ˆæœ¬

### æ•ˆæœ
- âœ… æœç´¢å¼•æ“æ­£å¸¸å·¥ä½œ
- âœ… å…¼å®¹æ‰€æœ‰ tantivy ç‰ˆæœ¬
- âœ… æœç´¢è´¨é‡ä¸å˜ï¼ˆä»ä½¿ç”¨ BM25ï¼‰

### ä½¿ç”¨æ–¹æ³•
```bash
# 1. æµ‹è¯•
python test_simple_search.py

# 2. é‡å¯ Streamlit
streamlit run streamlit_app.py

# 3. ä½¿ç”¨æœç´¢åŠŸèƒ½
```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-14 02:01:27  
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶æµ‹è¯•  
**æ¨è**: ä½¿ç”¨ç®€åŒ–ç‰ˆ (search_engine_simple.py)
